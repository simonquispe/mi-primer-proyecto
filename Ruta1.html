<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Avanzado de Alumbrado P√∫blico - Sistema de Registro Matricial</title>
    
    <!-- CDN Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/locale/es.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        :root {
            --primary-color: #3498db;
            --secondary-color: #2c3e50;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --info-color: #17a2b8;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --border-color: #e9ecef;
            --shadow: 0 4px 15px rgba(0,0,0,0.1);
            --border-radius: 12px;
            --transition: all 0.3s ease;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--dark-color);
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }
        
        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        .header p {
            font-size: 18px;
            opacity: 0.9;
        }
        
        .theme-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 10px;
            border-radius: 50%;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .theme-toggle:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .filters-section {
            background: var(--light-color);
            padding: 25px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .filters-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .filter-group label {
            font-weight: 600;
            color: var(--secondary-color);
            font-size: 14px;
        }
        
        .filter-group select,
        .filter-group input {
            padding: 12px 15px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            transition: var(--transition);
            background: white;
        }
        
        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        .filter-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .btn {
            background: linear-gradient(135deg, var(--primary-color), #2980b9);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--success-color), #219653);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, var(--warning-color), #e67e22);
        }
        
        .btn-info {
            background: linear-gradient(135deg, var(--info-color), #147483);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--danger-color), #c0392b);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .section {
            padding: 25px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .section h2 {
            color: var(--secondary-color);
            margin-bottom: 20px;
            font-size: 24px;
            font-weight: 600;
        }
        
        .data-input-section {
            background: var(--light-color);
            display: none;
        }
        
        .data-input-section.active {
            display: block;
        }
        
        /* NUEVOS ESTILOS PARA DASHBOARD DE EFICIENCIA */
        .efficiency-dashboard {
            background: var(--light-color);
            display: none;
        }
        
        .efficiency-dashboard.active {
            display: block;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .metric-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 25px;
            box-shadow: var(--shadow);
            text-align: center;
            position: relative;
            overflow: hidden;
            transition: var(--transition);
        }
        
        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), var(--success-color));
        }
        
        .metric-value {
            font-size: 36px;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 10px;
            display: block;
        }
        
        .metric-label {
            font-size: 14px;
            color: var(--secondary-color);
            font-weight: 600;
            margin-bottom: 15px;
        }
        
        .metric-change {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 15px;
            font-weight: 600;
        }
        
        .metric-change.positive {
            background: #d4edda;
            color: var(--success-color);
        }
        
        .metric-change.negative {
            background: #f8d7da;
            color: var(--danger-color);
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .chart-container {
            background: white;
            border-radius: var(--border-radius);
            padding: 25px;
            box-shadow: var(--shadow);
            position: relative;
        }
        
        .chart-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--secondary-color);
            margin-bottom: 20px;
            text-align: center;
        }
        
        .chart-wrapper {
            position: relative;
            height: 300px;
        }
        
        .efficiency-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-top: 30px;
        }
        
        .efficiency-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 25px;
            box-shadow: var(--shadow);
            text-align: center;
        }
        
        .efficiency-card.ampliacion {
            border-left: 5px solid var(--success-color);
        }
        
        .efficiency-card.mejoramiento {
            border-left: 5px solid var(--danger-color);
        }
        
        .efficiency-percentage {
            font-size: 48px;
            font-weight: 700;
            margin: 15px 0;
        }
        
        .efficiency-card.ampliacion .efficiency-percentage {
            color: var(--success-color);
        }
        
        .efficiency-card.mejoramiento .efficiency-percentage {
            color: var(--danger-color);
        }
        
        .efficiency-label {
            font-size: 16px;
            font-weight: 600;
            color: var(--secondary-color);
            margin-bottom: 10px;
        }
        
        .efficiency-details {
            font-size: 14px;
            color: #666;
            margin-top: 15px;
        }
        
        .progress-ring {
            width: 120px;
            height: 120px;
            margin: 0 auto 20px;
            position: relative;
        }
        
        .progress-ring svg {
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
        }
        
        .progress-ring circle {
            fill: none;
            stroke-width: 8;
        }
        
        .progress-ring .background {
            stroke: #e9ecef;
        }
        
        .progress-ring .progress {
            stroke-linecap: round;
            transition: stroke-dasharray 0.5s ease;
        }
        
        .progress-ring .ampliacion {
            stroke: var(--success-color);
        }
        
        .progress-ring .mejoramiento {
            stroke: var(--danger-color);
        }
        
        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 18px;
            font-weight: 700;
            color: var(--secondary-color);
        }
        
        .table-container {
            background: white;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
            position: relative;
        }
        
        .table-wrapper {
            overflow-x: auto;
            max-height: 600px;
            overflow-y: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            /* min-width: 1400px; */ /* Eliminado para evitar scroll horizontal */
        }
        
        th {
            background: linear-gradient(135deg, var(--primary-color), #2980b9);
            color: white;
            padding: 15px 10px;
            text-align: center;
            font-weight: 600;
            font-size: 11px;
            border: 1px solid #2980b9;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        td {
            padding: 10px;
            text-align: center;
            border: 1px solid var(--border-color);
            font-size: 12px;
        }
        
        tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        tr:hover {
            background-color: #e3f2fd;
        }
        
        .input-cell {
            background: white;
            border: 1px solid var(--border-color);
            text-align: center;
            cursor: pointer;
            font-size: 12px;
            min-width: 50px;
            padding: 8px;
            transition: var(--transition);
        }
        
        .input-cell:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        .input-cell.error {
            border-color: var(--danger-color);
            background-color: #ffeaea;
        }
        
        .variable-cell {
            max-width: 150px;
            font-size: 11px;
            text-align: left;
            padding-left: 12px;
            font-weight: 500;
        }
        
        .total-cell {
            background-color: #e8f4fd !important;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .ampliacion-header {
            background: linear-gradient(135deg, #27ae60, #219653) !important;
        }
        
        .mejoramiento-header {
            background: linear-gradient(135deg, #e74c3c, #c0392b) !important;
        }

        .table-title-section {
            padding: 10px 15px;
            color: white;
            border-radius: 8px 8px 0 0;
            font-size: 18px;
            font-weight: 600;
        }

        .table-container-vertical + .table-container-vertical {
            margin-top: 20px;
        }
        
        .alert {
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            border-left: 4px solid;
        }
        
        .alert-success {
            background: #d4edda;
            border-color: var(--success-color);
            color: #155724;
        }
        
        .alert-warning {
            background: #fff3cd;
            border-color: var(--warning-color);
            color: #856404;
        }
        
        .alert-danger {
            background: #f8d7da;
            border-color: var(--danger-color);
            color: #721c24;
        }

        /* NUEVOS ESTILOS PARA MENSAJE DE CONFIRMACI√ìN */
        .mensaje-confirmacion {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, var(--success-color), #219653);
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            font-weight: 600;
            font-size: 16px;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .mensaje-confirmacion.mostrar {
            transform: translateX(0);
        }
        
        @media (max-width: 768px) {
            .filters-container {
                grid-template-columns: 1fr;
            }
            
            .filter-actions {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
            
            .section {
                padding: 15px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 24px;
            }
            
            .metrics-grid {
                grid-template-columns: 1fr;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .efficiency-comparison {
                grid-template-columns: 1fr;
            }

            .mensaje-confirmacion {
                top: 10px;
                right: 10px;
                left: 10px;
                transform: translateY(-100px);
            }

            .mensaje-confirmacion.mostrar {
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <button class="theme-toggle" onclick="toggleTheme()" title="Cambiar tema">
                üåô
            </button>
            <h1>üìä Dashboard Avanzado de Alumbrado P√∫blico</h1>
            <p>Sistema de Registro Matricial - An√°lisis Inteligente de Solicitudes de Dise√±o T√©cnico</p>
        </div>
        
        <div class="filters-section">
            <div class="filters-container">
                <div class="filter-group">
                    <label for="gestion-select">Gesti√≥n:</label>
                    <select id="gestion-select">
                        <option value="">Todas las gestiones</option>
                        <option value="2023">2023</option>
                        <option value="2024">2024</option>
                        <option value="2025" selected>2025</option>
                        <option value="2026">2026</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="mes-select">Mes:</label>
                    <select id="mes-select">
                        <option value="">Todos los meses</option>
                        <option value="ENERO">Enero</option>
                        <option value="FEBRERO">Febrero</option>
                        <option value="MARZO">Marzo</option>
                        <option value="ABRIL">Abril</option>
                        <option value="MAYO">Mayo</option>
                        <option value="JUNIO">Junio</option>
                        <option value="JULIO">Julio</option>
                        <option value="AGOSTO">Agosto</option>
                        <option value="SEPTIEMBRE">Septiembre</option>
                        <option value="OCTUBRE">Octubre</option>
                        <option value="NOVIEMBRE">Noviembre</option>
                        <option value="DICIEMBRE">Diciembre</option>
                    </select>
                </div>
            </div>
            
            <div class="filter-actions">
                <button class="btn" onclick="cargarTabla()">
                    üìù Cargar Tabla para Editar
                </button>
                <button class="btn btn-success" onclick="guardarDatos()">
                    üíæ Guardar Datos
                </button>
                <button class="btn btn-danger" onclick="limpiarDatos()">
                    üßπ Limpiar Datos
                </button>
                <button class="btn btn-info" onclick="calcularTotales()">
                    üßÆ Recalcular Totales
                </button>
                <button class="btn btn-warning" onclick="mostrarDashboardEficiencia()">
                    üìà Ver Dashboard de Eficiencia
                </button>
                <button class="btn btn-info" onclick="exportarDatosDashboard()" style="display: none;" id="btn-exportar">
                    üìä Exportar Datos Dashboard
                </button>
            </div>
        </div>
        
        <!-- Alertas -->
        <div id="alertas-container"></div>
        
        <!-- Mensaje de confirmaci√≥n personalizado -->
        <div id="mensaje-confirmacion" class="mensaje-confirmacion">
            <span>‚úÖ</span>
            <span id="texto-confirmacion">datos guardados</span>
        </div>
        
        <!-- Secci√≥n de ingreso de datos -->
        <div class="section data-input-section" id="tabla-container">
            <h2>‚ûï Ingreso de Datos - <span id="periodo-mostrado"></span></h2>

            <div id="tablas-verticales-container">
                <div class="table-container-vertical">
                    <h3 class="table-title-section ampliacion-header">AMPLIACI√ìN</h3>
                    <div class="table-wrapper">
                        <table id="data-table-ampliacion" class="editable-table">
                            <thead>
                                <tr>
                                    <th style="width: 80px;">GESTI√ìN</th>
                                    <th style="width: 80px;">MES</th>
                                    <th style="width: 180px;">VARIABLES</th>
                                    <th style="width: 50px;">COTAHUMA</th>
                                    <th style="width: 50px;">MAX PAREDES</th>
                                    <th style="width: 50px;">PERIFERICA</th>
                                    <th style="width: 50px;">SAN ANTONIO</th>
                                    <th style="width: 50px;">SUR</th>
                                    <th style="width: 50px;">MALLASA</th>
                                    <th style="width: 50px;">CENTRO</th>
                                    <th style="width: 50px;">HAMPATURI</th>
                                    <th style="width: 50px;">ZONGO</th>
                                    <th style="width: 70px;">TOTAL(A)</th>
                                    <th style="width: 60px;">ACCIONES</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Filas de Ampliaci√≥n se cargar√°n aqu√≠ -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="table-container-vertical">
                    <h3 class="table-title-section mejoramiento-header">MEJORAMIENTO</h3>
                    <div class="table-wrapper">
                        <table id="data-table-mejoramiento" class="editable-table">
                            <thead>
                                <tr>
                                    <th style="width: 80px;">GESTI√ìN</th>
                                    <th style="width: 80px;">MES</th>
                                    <th style="width: 180px;">VARIABLES</th>
                                    <th style="width: 50px;">COTAHUMA</th>
                                    <th style="width: 50px;">MAX PAREDES</th>
                                    <th style="width: 50px;">PERIFERICA</th>
                                    <th style="width: 50px;">SAN ANTONIO</th>
                                    <th style="width: 50px;">SUR</th>
                                    <th style="width: 50px;">MALLASA</th>
                                    <th style="width: 50px;">CENTRO</th>
                                    <th style="width: 50px;">HAMPATURI</th>
                                    <th style="width: 50px;">ZONGO</th>
                                    <th style="width: 70px;">TOTAL(M)</th>
                                    <th style="width: 70px;">TOTAL GENERAL</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Filas de Mejoramiento se cargar√°n aqu√≠ -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- NUEVA SECCI√ìN: Dashboard de Eficiencia -->
        <div class="section efficiency-dashboard" id="dashboard-eficiencia">
            <h2>üìà Dashboard de Eficiencia - <span id="periodo-eficiencia"></span></h2>
            
            <!-- M√©tricas principales -->
            <div class="metrics-grid">
                <div class="metric-card">
                    <span class="metric-value" id="total-ampliacion">16</span>
                    <div class="metric-label">Total Ampliaci√≥n</div>
                    <span class="metric-change positive">+0.6%</span>
                </div>
                <div class="metric-card">
                    <span class="metric-value" id="total-mejoramiento">0</span>
                    <div class="metric-label">Total Mejoramiento</div>
                    <span class="metric-change positive">+7.2%</span>
                </div>
                <div class="metric-card">
                    <span class="metric-value" id="eficiencia-ampliacion">12.3%</span>
                    <div class="metric-label">Eficiencia Ampliaci√≥n</div>
                    <div class="progress-ring">
                        <svg>
                            <circle class="background" cx="60" cy="60" r="54"></circle>
                            <circle class="progress ampliacion" cx="60" cy="60" r="54" id="progress-ampliacion"></circle>
                        </svg>
                        <div class="progress-text" id="progress-text-ampliacion">12.3%</div>
                    </div>
                </div>
                <div class="metric-card">
                    <span class="metric-value" id="eficiencia-mejoramiento">0.0%</span>
                    <div class="metric-label">Eficiencia Mejoramiento</div>
                    <div class="progress-ring">
                        <svg>
                            <circle class="background" cx="60" cy="60" r="54"></circle>
                            <circle class="progress mejoramiento" cx="60" cy="60" r="54" id="progress-mejoramiento"></circle>
                        </svg>
                        <div class="progress-text" id="progress-text-mejoramiento">0.0%</div>
                    </div>
                </div>
                <div class="metric-card">
                    <span class="metric-value" id="total-general">16</span>
                    <div class="metric-label">Total General</div>
                    <span class="metric-change negative">-4.0%</span>
                </div>
                <div class="metric-card">
                    <span class="metric-value" id="promedio-eficiencia">6.2%</span>
                    <div class="metric-label">Promedio Eficiencia</div>
                    <div class="progress-ring">
                        <svg>
                            <circle class="background" cx="60" cy="60" r="54"></circle>
                            <circle class="progress" cx="60" cy="60" r="54" id="progress-promedio" style="stroke: var(--primary-color);"></circle>
                        </svg>
                        <div class="progress-text" id="progress-text-promedio">6.2%</div>
                    </div>
                </div>
            </div>
            
            <!-- Gr√°ficas -->
            <div class="charts-grid">
                <div class="chart-container">
                    <div class="chart-title">Ampliaci√≥n - Eficiencia de Dise√±os</div>
                    <div class="chart-wrapper">
                        <canvas id="chart-ampliacion"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Mejoramiento - Eficiencia de Dise√±os</div>
                    <div class="chart-wrapper">
                        <canvas id="chart-mejoramiento"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Distribuci√≥n por Macrodistrito</div>
                    <div class="chart-wrapper">
                        <canvas id="chart-distribucion"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Comparaci√≥n de Eficiencia</div>
                    <div class="chart-wrapper">
                        <canvas id="chart-comparacion"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Variables globales
        let datosActuales = [];
        let datosGuardados = JSON.parse(localStorage.getItem('datosAlumbrado')) || [];
        let temaOscuro = localStorage.getItem('temaOscuro') === 'true';
        let chartsInstances = {}; // Para almacenar instancias de gr√°ficos
        
        // Aplicar tema al cargar
        if (temaOscuro) {
            document.body.classList.add('dark-theme');
            document.querySelector('.theme-toggle').textContent = '‚òÄÔ∏è';
        }
        
        // Funci√≥n para cambiar tema
        function toggleTheme() {
            temaOscuro = !temaOscuro;
            document.body.classList.toggle('dark-theme');
            document.querySelector('.theme-toggle').textContent = temaOscuro ? '‚òÄÔ∏è' : 'üåô';
            localStorage.setItem('temaOscuro', temaOscuro);
        }
        
        // Funci√≥n para mostrar alertas
        function mostrarAlerta(mensaje, tipo = 'info') {
            const container = document.getElementById('alertas-container');
            const alerta = document.createElement('div');
            alerta.className = `alert alert-${tipo}`;
            alerta.textContent = mensaje;
            
            container.appendChild(alerta);
            
            setTimeout(() => {
                alerta.remove();
            }, 5000);
        }

        // NUEVA FUNCI√ìN: Mostrar mensaje de confirmaci√≥n personalizado
        function mostrarMensajeConfirmacion(mensaje, duracion = 3000) {
            const mensajeEl = document.getElementById('mensaje-confirmacion');
            const textoEl = document.getElementById('texto-confirmacion');
            
            textoEl.textContent = mensaje;
            mensajeEl.classList.add('mostrar');
            
            setTimeout(() => {
                mensajeEl.classList.remove('mostrar');
            }, duracion);
        }

        // MODIFIED FUNCTION: Limpiar datos de las tablas
        function limpiarDatos() {
            const filasAmpliacion = document.querySelectorAll('#data-table-ampliacion tbody tr');
            const filasMejoramiento = document.querySelectorAll('#data-table-mejoramiento tbody tr');
            
            if (filasAmpliacion.length === 0 && filasMejoramiento.length === 0) {
                mostrarAlerta('No hay datos cargados para limpiar', 'warning');
                return;
            }
            
            if (!confirm('¬øEst√° seguro de que desea limpiar todos los datos de las tablas? Esta acci√≥n no se puede deshacer.')) {
                return;
            }
            
            const celdasEditables = document.querySelectorAll('#data-table-ampliacion .input-cell, #data-table-mejoramiento .input-cell');
            let contador = 0;
            
            celdasEditables.forEach(celda => {
                if (!celda.readOnly && !celda.disabled) {
                    celda.value = '';
                    celda.classList.remove('error');
                    contador++;
                }
            });
            
            calcularTotales();
            actualizarGraficosEnTiempoReal();
            
            mostrarMensajeConfirmacion(`Datos limpiados (${contador} celdas vaciadas)`);
            mostrarAlerta(`‚úÖ Se han limpiado ${contador} celdas de datos correctamente`, 'success');
        }
        
        // Funci√≥n para generar ID √∫nico
        function generarId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }
        
        // Funci√≥n para validar n√∫mero
        function validarNumero(valor) {
            const num = parseFloat(valor);
            return !isNaN(num) && num >= 0 ? num : 0;
        }
        
        // NUEVA FUNCI√ìN: Mostrar Dashboard de Eficiencia
        function mostrarDashboardEficiencia() {
            const mes = document.getElementById('mes-select').value;
            const gestion = document.getElementById('gestion-select').value || new Date().getFullYear();
            
            if (!mes) {
                mostrarAlerta('Por favor seleccione un mes para ver el dashboard de eficiencia', 'warning');
                return;
            }
            
            // Mostrar tabla y dashboard simult√°neamente
            document.getElementById('tabla-container').classList.add('active');
            document.getElementById('dashboard-eficiencia').classList.add('active');
            
            // Mostrar bot√≥n de exportar
            document.getElementById('btn-exportar').style.display = 'inline-flex';
            
            // Actualizar per√≠odo
            document.getElementById('periodo-eficiencia').textContent = `${mes} ${gestion}`;
            
            // Calcular y mostrar m√©tricas
            calcularMetricasEficiencia();
            
            // Generar gr√°ficos
            generarGraficos();
            
            // Scroll al dashboard
            document.getElementById('dashboard-eficiencia').scrollIntoView({ behavior: 'smooth' });
        }
        
        // MEJORAR FUNCI√ìN: Calcular m√©tricas de eficiencia con validaciones
        function calcularMetricasEficiencia() {
            const datosSolicitudes = obtenerDatosPorVariable('TOTAL DE SOLICITUDES RECIBIDAS');
            const datosDisenos = obtenerDatosPorVariable('DISE√ëOS TECNICOS APROBADOS');
            
            if (!datosSolicitudes || !datosDisenos) {
                mostrarAlerta('Debe cargar los datos primero para calcular la eficiencia', 'warning');
                return {
                    eficienciaAmpliacion: 0,
                    eficienciaMejoramiento: 0,
                    promedioEficiencia: 0,
                    totalSolicitudesAmpliacion: 0,
                    totalSolicitudesMejoramiento: 0,
                    totalDisenosAmpliacion: 0,
                    totalDisenosMejoramiento: 0
                };
            }
            
            // Obtener totales
            const totalSolicitudesAmpliacion = datosSolicitudes.ampliacion.total;
            const totalSolicitudesMejoramiento = datosSolicitudes.mejoramiento.total;
            const totalDisenosAmpliacion = datosDisenos.ampliacion.total;
            const totalDisenosMejoramiento = datosDisenos.mejoramiento.total;

            // Calcular eficiencias con validaci√≥n
            const eficienciaAmpliacion = totalSolicitudesAmpliacion > 0 ?
                Math.min((totalDisenosAmpliacion / totalSolicitudesAmpliacion * 100), 100) : 0;
            const eficienciaMejoramiento = totalSolicitudesMejoramiento > 0 ?
                Math.min((totalDisenosMejoramiento / totalSolicitudesMejoramiento * 100), 100) : 0;
            
            // Calcular promedio ponderado
            const totalSolicitudes = totalSolicitudesAmpliacion + totalSolicitudesMejoramiento;
            const promedioEficiencia = totalSolicitudes > 0 ?
                ((eficienciaAmpliacion * totalSolicitudesAmpliacion) + (eficienciaMejoramiento * totalSolicitudesMejoramiento)) / totalSolicitudes : 0;
            
            // Actualizar m√©tricas en el DOM
            document.getElementById('total-ampliacion').textContent = totalSolicitudesAmpliacion;
            document.getElementById('total-mejoramiento').textContent = totalSolicitudesMejoramiento;
            document.getElementById('eficiencia-ampliacion').textContent = eficienciaAmpliacion.toFixed(1) + '%';
            document.getElementById('eficiencia-mejoramiento').textContent = eficienciaMejoramiento.toFixed(1) + '%';
            document.getElementById('total-general').textContent = totalSolicitudesAmpliacion + totalSolicitudesMejoramiento;
            document.getElementById('promedio-eficiencia').textContent = promedioEficiencia.toFixed(1) + '%';
            
            // Actualizar anillos de progreso
            actualizarAnilloProgreso('progress-ampliacion', 'progress-text-ampliacion', eficienciaAmpliacion);
            actualizarAnilloProgreso('progress-mejoramiento', 'progress-text-mejoramiento', eficienciaMejoramiento);
            actualizarAnilloProgreso('progress-promedio', 'progress-text-promedio', promedioEficiencia);

            // Actualizar indicadores de cambio (simulado)
            actualizarIndicadoresCambio(eficienciaAmpliacion, eficienciaMejoramiento, promedioEficiencia);

            return {
                eficienciaAmpliacion,
                eficienciaMejoramiento,
                promedioEficiencia,
                totalSolicitudesAmpliacion,
                totalSolicitudesMejoramiento,
                totalDisenosAmpliacion,
                totalDisenosMejoramiento
            };
        }
        
        // NUEVA FUNCI√ìN: Actualizar anillo de progreso
        function actualizarAnilloProgreso(circleId, textId, porcentaje) {
            const circle = document.getElementById(circleId);
            const text = document.getElementById(textId);
            const radius = 54;
            const circumference = 2 * Math.PI * radius;
            const offset = circumference - (porcentaje / 100) * circumference;
            
            circle.style.strokeDasharray = circumference;
            circle.style.strokeDashoffset = offset;
            text.textContent = porcentaje.toFixed(1) + '%';
        }
        
        // MEJORAR FUNCI√ìN: Generar gr√°ficos con datos actualizados
        function generarGraficos() {
            // Limpiar gr√°ficos existentes
            Object.values(chartsInstances).forEach(chart => {
                if (chart && typeof chart.destroy === 'function') {
                    chart.destroy();
                }
            });
            chartsInstances = {};
            
            // Validar datos antes de generar gr√°ficos
            if (!validarConsistenciaDatos()) {
                return;
            }
            
            const datosSolicitudes = obtenerDatosPorVariable('TOTAL DE SOLICITUDES RECIBIDAS');
            const datosDisenos = obtenerDatosPorVariable('DISE√ëOS TECNICOS APROBADOS');
            
            if (!datosSolicitudes || !datosDisenos) {
                mostrarAlerta('No hay datos suficientes para generar los gr√°ficos', 'warning');
                return;
            }
            
            // Datos para gr√°ficos
            const macrodistritos = ['COTAHUMA', 'MAX PAREDES', 'PERIFERICA', 'SAN ANTONIO', 'SUR', 'MALLASA', 'CENTRO', 'HAMPATURI', 'ZONGO'];
            const coloresAmpliacion = '#27ae60';
            const coloresMejoramiento = '#e74c3c';
            
            // Generar todos los gr√°ficos
            generarGraficoDonutMejorado('chart-ampliacion', datosSolicitudes, datosDisenos, 'ampliacion', coloresAmpliacion, 'Ampliaci√≥n');
            generarGraficoDonutMejorado('chart-mejoramiento', datosSolicitudes, datosDisenos, 'mejoramiento', coloresMejoramiento, 'Mejoramiento');
            generarGraficoDistribucionMejorado('chart-distribucion', datosSolicitudes, macrodistritos);
            generarGraficoComparacionMejorado('chart-comparacion', datosSolicitudes, datosDisenos, macrodistritos);
        }
        
        // NUEVA FUNCI√ìN: Generar gr√°fico donut mejorado
        function generarGraficoDonutMejorado(canvasId, datosSolicitudes, datosDisenos, tipo, color, titulo) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            
            const totalSolicitudes = datosSolicitudes[tipo].total;
            const totalDisenos = datosDisenos[tipo].total;
            const pendientes = Math.max(0, totalSolicitudes - totalDisenos);
            const eficiencia = totalSolicitudes > 0 ? (totalDisenos / totalSolicitudes * 100) : 0;
            
            const config = {
                type: 'doughnut',
                data: {
                    labels: ['Dise√±os Aprobados', 'Pendientes'],
                    datasets: [{
                        data: [totalDisenos, pendientes],
                        backgroundColor: [color, '#e9ecef'],
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true,
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    },
                    cutout: '65%',
                    animation: {
                        animateRotate: true,
                        duration: 1000
                    }
                }
            };
            
            chartsInstances[canvasId] = new Chart(ctx, config);
            
            // Agregar texto central con eficiencia
            setTimeout(() => {
                const canvas = document.getElementById(canvasId);
                const centerX = canvas.width / 2;
                const centerY = canvas.height / 2;
                
                ctx.save();
                ctx.font = 'bold 20px Arial';
                ctx.fillStyle = color;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(eficiencia.toFixed(1) + '%', centerX, centerY - 5);
                
                ctx.font = '12px Arial';
                ctx.fillStyle = '#666';
                ctx.fillText('Eficiencia', centerX, centerY + 15);
                ctx.restore();
            }, 100);
        }
        
        // NUEVA FUNCI√ìN: Generar gr√°fico de distribuci√≥n mejorado
        function generarGraficoDistribucionMejorado(canvasId, datosSolicitudes, macrodistritos) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            
            const datosAmpliacion = [];
            const datosMejoramiento = [];
            const etiquetas = [];
            
            const colores = [
                '#3498db', '#e74c3c', '#27ae60', '#f39c12', 
                '#9b59b6', '#1abc9c', '#34495e', '#e67e22', '#95a5a6'
            ];
            
            macrodistritos.forEach((macro, index) => {
                const macroKey = macro.toLowerCase().replace(' ', '_');
                const valorAmpliacion = datosSolicitudes.ampliacion.macrodistritos[macroKey] || 0;
                const valorMejoramiento = datosSolicitudes.mejoramiento.macrodistritos[macroKey] || 0;
                
                if (valorAmpliacion > 0 || valorMejoramiento > 0) {
                    etiquetas.push(macro);
                    datosAmpliacion.push(valorAmpliacion);
                    datosMejoramiento.push(valorMejoramiento);
                }
            });
            
            const config = {
                type: 'bar',
                data: {
                    labels: etiquetas,
                    datasets: [
                        {
                            label: 'Ampliaci√≥n',
                            data: datosAmpliacion,
                            backgroundColor: '#27ae60',
                            borderRadius: 4,
                            borderSkipped: false
                        },
                        {
                            label: 'Mejoramiento',
                            data: datosMejoramiento,
                            backgroundColor: '#e74c3c',
                            borderRadius: 4,
                            borderSkipped: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 20
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1,
                                callback: function(value) {
                                    return Number.isInteger(value) ? value : '';
                                }
                            },
                            grid: {
                                color: '#f0f0f0'
                            }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45,
                                font: {
                                    size: 10
                                }
                            },
                            grid: {
                                display: false
                            }
                        }
                    },
                    animation: {
                        duration: 1000,
                        easing: 'easeInOutQuart'
                    }
                }
            };
            
            chartsInstances[canvasId] = new Chart(ctx, config);
        }
        
        // NUEVA FUNCI√ìN: Generar gr√°fico de comparaci√≥n mejorado
        function generarGraficoComparacionMejorado(canvasId, datosSolicitudes, datosDisenos, macrodistritos) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            
            const eficienciasAmpliacion = [];
            const eficienciasMejoramiento = [];
            const etiquetas = [];
            
            macrodistritos.forEach(macro => {
                const macroKey = macro.toLowerCase().replace(' ', '_');
                
                // Ampliaci√≥n
                const solicitudesAmp = datosSolicitudes.ampliacion.macrodistritos[macroKey] || 0;
                const disenosAmp = datosDisenos.ampliacion.macrodistritos[macroKey] || 0;
                const eficienciaAmp = solicitudesAmp > 0 ? (disenosAmp / solicitudesAmp * 100) : 0;
                
                // Mejoramiento
                const solicitudesMej = datosSolicitudes.mejoramiento.macrodistritos[macroKey] || 0;
                const disenosMej = datosDisenos.mejoramiento.macrodistritos[macroKey] || 0;
                const eficienciaMej = solicitudesMej > 0 ? (disenosMej / solicitudesMej * 100) : 0;
                
                // Solo incluir si hay datos
                if (solicitudesAmp > 0 || solicitudesMej > 0) {
                    etiquetas.push(macro);
                    eficienciasAmpliacion.push(eficienciaAmp);
                    eficienciasMejoramiento.push(eficienciaMej);
                }
            });
            
            const config = {
                type: 'bar',
                data: {
                    labels: etiquetas,
                    datasets: [
                        {
                            label: 'Eficiencia Ampliaci√≥n (%)',
                            data: eficienciasAmpliacion,
                            backgroundColor: '#27ae60',
                            borderRadius: 4,
                            borderSkipped: false
                        },
                        {
                            label: 'Eficiencia Mejoramiento (%)',
                            data: eficienciasMejoramiento,
                            backgroundColor: '#e74c3c',
                            borderRadius: 4,
                            borderSkipped: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 20
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.parsed.y.toFixed(1)}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                },
                                stepSize: 20
                            },
                            grid: {
                                color: '#f0f0f0'
                            }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45,
                                font: {
                                    size: 10
                                }
                            },
                            grid: {
                                display: false
                            }
                        }
                    },
                    animation: {
                        duration: 1000,
                        easing: 'easeInOutQuart'
                    }
                }
            };
            
            chartsInstances[canvasId] = new Chart(ctx, config);
        }
        
        // NUEVA FUNCI√ìN: Actualizar gr√°ficos en tiempo real
        function actualizarGraficosEnTiempoReal() {
            // Solo actualizar si el dashboard est√° visible
            if (document.getElementById('dashboard-eficiencia').classList.contains('active')) {
                calcularMetricasEficiencia();
                generarGraficos();
            }
        }
        
        // NUEVA FUNCI√ìN: Exportar datos del dashboard
        function exportarDatosDashboard() {
            const metricas = calcularMetricasEficiencia();
            const eficienciasPorMacro = calcularEficienciaPorMacrodistrito();
            
            const datosExport = {
                fecha: new Date().toISOString(),
                periodo: document.getElementById('periodo-eficiencia').textContent,
                metricas: metricas,
                eficienciasPorMacrodistrito: eficienciasPorMacro,
                resumen: {
                    totalSolicitudes: metricas.totalSolicitudesAmpliacion + metricas.totalSolicitudesMejoramiento,
                    totalDisenos: metricas.totalDisenosAmpliacion + metricas.totalDisenosMejoramiento,
                    eficienciaGeneral: metricas.promedioEficiencia
                }
            };
            
            // Crear y descargar archivo JSON
            const blob = new Blob([JSON.stringify(datosExport, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `dashboard-eficiencia-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            mostrarAlerta('‚úÖ Datos del dashboard exportados correctamente', 'success');
        }
        
        // MODIFIED FUNCTION: Cargar tablas editables
        function cargarTabla() {
            const mes = document.getElementById('mes-select').value;
            const gestion = document.getElementById('gestion-select').value || new Date().getFullYear();
            
            if (!mes) {
                mostrarAlerta('Por favor seleccione un mes', 'warning');
                return;
            }
            
            document.getElementById('tabla-container').classList.add('active');
            document.getElementById('periodo-mostrado').textContent = `${mes} ${gestion}`;
            
            const tbodyAmpliacion = document.querySelector('#data-table-ampliacion tbody');
            const tbodyMejoramiento = document.querySelector('#data-table-mejoramiento tbody');
            tbodyAmpliacion.innerHTML = '';
            tbodyMejoramiento.innerHTML = '';
            
            const variables = [
                'N¬∞ DE SOLICITUDES RECIBIDAS',
                'N¬∞ DE SOLICITUDES PENDIENTES DEL MES ANTERIOR',
                'N¬∞ TOTAL DE SOLICITUDES RECIBIDAS',
                'N¬∞ DE DISE√ëOS TECNICOS APROBADOS'
            ];
            
            variables.forEach((variable, index) => {
                const id = generarId();
                const filaAmpliacion = crearFilaAmpliacion(gestion, mes, variable, index, id);
                const filaMejoramiento = crearFilaMejoramiento(gestion, mes, variable, index, id);
                tbodyAmpliacion.appendChild(filaAmpliacion);
                tbodyMejoramiento.appendChild(filaMejoramiento);
            });
            
            document.getElementById('tabla-container').scrollIntoView({ behavior: 'smooth' });
        }
        
        // NEW FUNCTION: Crear fila para tabla de Ampliaci√≥n
        function crearFilaAmpliacion(gestion, mes, variable, index, id) {
            const fila = document.createElement('tr');
            fila.dataset.id = id;
            fila.dataset.filaIndex = index;
            
            const macrodistritos = ['cotahuma', 'max_paredes', 'periferica', 'san_antonio', 'zona_sur', 'mallasa', 'centro', 'hampaturi', 'zongo'];
            
            let html = `
                <td class="variable-cell">${gestion}</td>
                <td class="variable-cell">${mes}</td>
                <td class="variable-cell">${variable}</td>
            `;
            
            macrodistritos.forEach(macro => {
                const readonly = index === 2 ? 'readonly style="background-color: #f0f0f0;"' : '';
                html += `<td><input type="number" class="input-cell" data-tipo="ampliacion" data-macro="${macro}" min="0" step="1" onchange="calcularTotalesFila(this)" ${readonly}></td>`;
            });
            html += `<td class="total-cell" data-total="ampliacion">0</td>`;
            html += `<td><button class="btn btn-danger" onclick="eliminarFila(this)" style="padding: 5px 10px; font-size: 12px;">üóëÔ∏è</button></td>`;

            fila.innerHTML = html;
            return fila;
        }

        // NEW FUNCTION: Crear fila para tabla de Mejoramiento
        function crearFilaMejoramiento(gestion, mes, variable, index, id) {
            const fila = document.createElement('tr');
            fila.dataset.id = id;
            fila.dataset.filaIndex = index;

            const macrodistritos = ['cotahuma', 'max_paredes', 'periferica', 'san_antonio', 'zona_sur', 'mallasa', 'centro', 'hampaturi', 'zongo'];

            let html = `
                <td class="variable-cell">${gestion}</td>
                <td class="variable-cell">${mes}</td>
                <td class="variable-cell">${variable}</td>
            `;
            
            macrodistritos.forEach(macro => {
                const readonly = index === 2 ? 'readonly style="background-color: #f0f0f0;"' : '';
                html += `<td><input type="number" class="input-cell" data-tipo="mejoramiento" data-macro="${macro}" min="0" step="1" onchange="calcularTotalesFila(this)" ${readonly}></td>`;
            });
            html += `<td class="total-cell" data-total="mejoramiento">0</td>`;
            html += `<td class="total-cell" data-total="general">0</td>`;
            
            fila.innerHTML = html;
            return fila;
        }
        
        // MODIFIED FUNCTION: Calcular totales de fila con actualizaci√≥n autom√°tica
        function calcularTotalesFila(input) {
            const fila = input.closest('tr');
            const tipo = input.dataset.tipo;
            const inputs = fila.querySelectorAll(`.input-cell[data-tipo="${tipo}"]`);
            
            let total = 0;
            inputs.forEach(inp => {
                total += validarNumero(inp.value);
            });
            
            fila.querySelector(`[data-total="${tipo}"]`).textContent = total;
            
            validarCelda(input);
            actualizarTerceraFila();
            calcularTotalGeneralFila(fila.dataset.id);
            
            actualizarGraficosEnTiempoReal();
        }

        // NEW FUNCTION: Calcular el total general para un par de filas
        function calcularTotalGeneralFila(id) {
            const filaAmpliacion = document.querySelector(`#data-table-ampliacion tr[data-id="${id}"]`);
            const filaMejoramiento = document.querySelector(`#data-table-mejoramiento tr[data-id="${id}"]`);

            if (filaAmpliacion && filaMejoramiento) {
                const totalAmpliacion = parseFloat(filaAmpliacion.querySelector('[data-total="ampliacion"]').textContent) || 0;
                const totalMejoramiento = parseFloat(filaMejoramiento.querySelector('[data-total="mejoramiento"]').textContent) || 0;
                const totalGeneral = totalAmpliacion + totalMejoramiento;

                filaMejoramiento.querySelector('[data-total="general"]').textContent = totalGeneral;
            }
        }

        // MODIFIED FUNCTION: Actualizar la tercera fila
        function actualizarTerceraFila() {
            actualizarTerceraFilaParaTabla('data-table-ampliacion');
            actualizarTerceraFilaParaTabla('data-table-mejoramiento');
            const filaAmp = document.querySelector('#data-table-ampliacion tbody tr:nth-child(3)');
            if(filaAmp) {
                calcularTotalGeneralFila(filaAmp.dataset.id);
            }
        }

        // NEW HELPER FUNCTION: Actualizar la tercera fila para una tabla espec√≠fica
        function actualizarTerceraFilaParaTabla(tableId) {
            const filas = document.querySelectorAll(`#${tableId} tbody tr`);
            
            if (filas.length >= 3) {
                const fila1 = filas[0];
                const fila2 = filas[1];
                const fila3 = filas[2];
                
                const macrodistritos = ['cotahuma', 'max_paredes', 'periferica', 'san_antonio', 'zona_sur', 'mallasa', 'centro', 'hampaturi', 'zongo'];
                const tipo = tableId.includes('ampliacion') ? 'ampliacion' : 'mejoramiento';
                
                let total = 0;
                
                macrodistritos.forEach(macro => {
                    const input1 = fila1.querySelector(`[data-macro="${macro}"]`);
                    const input2 = fila2.querySelector(`[data-macro="${macro}"]`);
                    const input3 = fila3.querySelector(`[data-macro="${macro}"]`);

                    const valor1 = validarNumero(input1 ? input1.value : 0);
                    const valor2 = validarNumero(input2 ? input2.value : 0);
                    const suma = valor1 + valor2;

                    if (input3) {
                        input3.value = suma;
                    }
                    total += suma;
                });
                
                const totalCell = fila3.querySelector(`[data-total="${tipo}"]`);
                if (totalCell) totalCell.textContent = total;
            }
        }
        
        // Funci√≥n para validar celda
        function validarCelda(input) {
            const valor = parseFloat(input.value);
            const variable = input.closest('tr').children[2].textContent;
            
            input.classList.remove('error');
            
            if (isNaN(valor) || valor < 0) {
                input.classList.add('error');
                return false;
            }
            
            if (variable.includes('%') && valor > 100) {
                input.classList.add('error');
                mostrarAlerta('Los porcentajes no pueden ser mayores a 100%', 'warning');
                return false;
            }
            
            return true;
        }
        
        // MODIFIED FUNCTION: Eliminar fila de ambas tablas
        function eliminarFila(boton) {
            if (confirm('¬øEst√° seguro de eliminar esta fila? (Se eliminar√° de ambas tablas)')) {
                const filaAEliminar = boton.closest('tr');
                const id = filaAEliminar.dataset.id;

                const otraFila = document.querySelector(`#data-table-mejoramiento tr[data-id="${id}"]`);

                filaAEliminar.remove();
                if (otraFila) {
                    otraFila.remove();
                }

                mostrarAlerta('Fila eliminada correctamente de ambas tablas', 'success');
            }
        }
        
        // MODIFIED FUNCTION: Calcular todos los totales
        function calcularTotales() {
            const filasAmpliacion = document.querySelectorAll('#data-table-ampliacion tbody tr');
            filasAmpliacion.forEach(fila => {
                const filaIndex = parseInt(fila.dataset.filaIndex);
                if (filaIndex !== 2) {
                    const primerInput = fila.querySelector('.input-cell');
                    if (primerInput) {
                        calcularTotalesFila(primerInput);
                    }
                }
            });

            const filasMejoramiento = document.querySelectorAll('#data-table-mejoramiento tbody tr');
            filasMejoramiento.forEach(fila => {
                const filaIndex = parseInt(fila.dataset.filaIndex);
                if (filaIndex !== 2) {
                    const primerInput = fila.querySelector('.input-cell');
                    if (primerInput) {
                        calcularTotalesFila(primerInput);
                    }
                }
            });
            mostrarAlerta('Totales recalculados correctamente', 'success');
        }
        
        // MODIFIED FUNCTION: Guardar datos
        function guardarDatos() {
            const filasAmpliacion = document.querySelectorAll('#data-table-ampliacion tbody tr');
            
            if (filasAmpliacion.length === 0) {
                mostrarAlerta('No hay datos para guardar. Primero cargue una tabla.', 'warning');
                return;
            }
            
            const nuevosRegistros = [];
            
            filasAmpliacion.forEach(filaAmp => {
                const id = filaAmp.dataset.id;
                const filaMej = document.querySelector(`#data-table-mejoramiento tr[data-id="${id}"]`);

                if (!filaMej) {
                    console.error(`No se encontr√≥ fila de mejoramiento para id ${id}`);
                    return;
                }

                const gestion = filaAmp.children[0].textContent;
                const mes = filaAmp.children[1].textContent;
                const variable = filaAmp.children[2].textContent;
                
                const registro = {
                    id: id,
                    gestion: parseInt(gestion),
                    mes: mes,
                    variable: variable,
                    timestamp: new Date().toISOString(),
                    macrodistritos: {}
                };
                
                const macrodistritos = ['cotahuma', 'max_paredes', 'periferica', 'san_antonio', 'zona_sur', 'mallasa', 'centro', 'hampaturi', 'zongo'];
                const inputsAmp = filaAmp.querySelectorAll('.input-cell');
                const inputsMej = filaMej.querySelectorAll('.input-cell');
                
                macrodistritos.forEach((macro, index) => {
                    registro.macrodistritos[macro] = {
                        ampliacion: validarNumero(inputsAmp[index] ? inputsAmp[index].value : 0),
                        mejoramiento: validarNumero(inputsMej[index] ? inputsMej[index].value : 0)
                    };
                });
                
                registro.totales = {
                    ampliacion: parseFloat(filaAmp.querySelector('[data-total="ampliacion"]').textContent),
                    mejoramiento: parseFloat(filaMej.querySelector('[data-total="mejoramiento"]').textContent),
                    general: parseFloat(filaMej.querySelector('[data-total="general"]').textContent)
                };
                
                nuevosRegistros.push(registro);
            });
            
            nuevosRegistros.forEach(nuevo => {
                const existente = datosGuardados.findIndex(d => d.id === nuevo.id);
                if (existente >= 0) {
                    datosGuardados[existente] = nuevo;
                } else {
                    datosGuardados.push(nuevo);
                }
            });
            
            localStorage.setItem('datosAlumbrado', JSON.stringify(datosGuardados));
            
            mostrarMensajeConfirmacion('datos guardados');
            mostrarAlerta('‚úÖ Datos guardados correctamente en el almacenamiento local', 'success');
        }
        
        // MODIFIED FUNCTION: Cargar datos de ejemplo
        function cargarDatosEjemplo() {
            document.getElementById('mes-select').value = 'JULIO';
            document.getElementById('gestion-select').value = '2025';
            cargarTabla();
            
            setTimeout(() => {
                const filasAmp = document.querySelectorAll('#data-table-ampliacion tbody tr');
                const filasMej = document.querySelectorAll('#data-table-mejoramiento tbody tr');
                
                if (filasAmp.length >= 4) {
                    // Fila 1 - Solicitudes Recibidas
                    const fila1InputsAmp = filasAmp[0].querySelectorAll('.input-cell');
                    [8, 0, 0, 0, 8, 0, 0, 0, 0].forEach((v, i) => { if(fila1InputsAmp[i]) fila1InputsAmp[i].value = v });
                    const fila1InputsMej = filasMej[0].querySelectorAll('.input-cell');
                    [0, 0, 0, 0, 0, 0, 0, 0, 0].forEach((v, i) => { if(fila1InputsMej[i]) fila1InputsMej[i].value = v });
                    
                    // Fila 2 - Pendientes
                    const fila2InputsAmp = filasAmp[1].querySelectorAll('.input-cell');
                    [8, 0, 0, 0, 0, 0, 0, 0, 0].forEach((v, i) => { if(fila2InputsAmp[i]) fila2InputsAmp[i].value = v });
                    const fila2InputsMej = filasMej[1].querySelectorAll('.input-cell');
                    [0, 0, 0, 0, 0, 0, 0, 0, 0].forEach((v, i) => { if(fila2InputsMej[i]) fila2InputsMej[i].value = v });

                    // Fila 4 - Aprobados
                    const fila4InputsAmp = filasAmp[3].querySelectorAll('.input-cell');
                    [2, 0, 0, 0, 0, 0, 0, 0, 0].forEach((v, i) => { if(fila4InputsAmp[i]) fila4InputsAmp[i].value = v });
                    const fila4InputsMej = filasMej[3].querySelectorAll('.input-cell');
                    [0, 0, 0, 0, 0, 0, 0, 0, 0].forEach((v, i) => { if(fila4InputsMej[i]) fila4InputsMej[i].value = v });
                    
                    calcularTotales();
                    mostrarAlerta('‚úÖ Datos de ejemplo cargados correctamente', 'success');
                }
            }, 500);
        }
        
        // MODIFIED FUNCTION: Obtener datos por variable y tipo
        function obtenerDatosPorVariable(nombreVariable, tipo = null) {
            const filasAmpliacion = document.querySelectorAll('#data-table-ampliacion tbody tr');
            let filaAmpliacionEncontrada = null;
            
            filasAmpliacion.forEach(fila => {
                const variableCell = fila.querySelector('.variable-cell:nth-child(3)');
                if (variableCell && variableCell.textContent.includes(nombreVariable)) {
                    filaAmpliacionEncontrada = fila;
                }
            });
            
            if (!filaAmpliacionEncontrada) return null;

            const id = filaAmpliacionEncontrada.dataset.id;
            const filaMejoramientoEncontrada = document.querySelector(`#data-table-mejoramiento tr[data-id="${id}"]`);

            if (!filaMejoramientoEncontrada) return null;
            
            const datos = {
                ampliacion: {
                    total: parseFloat(filaAmpliacionEncontrada.querySelector('[data-total="ampliacion"]').textContent) || 0,
                    macrodistritos: {}
                },
                mejoramiento: {
                    total: parseFloat(filaMejoramientoEncontrada.querySelector('[data-total="mejoramiento"]').textContent) || 0,
                    macrodistritos: {}
                },
                totalGeneral: parseFloat(filaMejoramientoEncontrada.querySelector('[data-total="general"]').textContent) || 0
            };
            
            const macrodistritos = ['cotahuma', 'max_paredes', 'periferica', 'san_antonio', 'zona_sur', 'mallasa', 'centro', 'hampaturi', 'zongo'];
            
            macrodistritos.forEach((macro, i) => {
                const inputAmpliacion = filaAmpliacionEncontrada.querySelectorAll('.input-cell')[i];
                datos.ampliacion.macrodistritos[macro] = inputAmpliacion ? (parseFloat(inputAmpliacion.value) || 0) : 0;

                const inputMejoramiento = filaMejoramientoEncontrada.querySelectorAll('.input-cell')[i];
                datos.mejoramiento.macrodistritos[macro] = inputMejoramiento ? (parseFloat(inputMejoramiento.value) || 0) : 0;
            });
            
            return tipo ? datos[tipo] : datos;
        }
        
        // NUEVA FUNCI√ìN: Actualizar indicadores de cambio
        function actualizarIndicadoresCambio(eficienciaAmp, eficienciaMej, promedio) {
            const cambios = document.querySelectorAll('.metric-change');
            
            // Simular cambios basados en la eficiencia actual
            const cambioAmp = eficienciaAmp > 10 ? '+0.6%' : '-0.3%';
            const cambioMej = eficienciaMej > 5 ? '+7.2%' : '-2.1%';
            const cambioGeneral = promedio > 8 ? '+2.4%' : '-4.0%';
            
            if (cambios.length >= 6) {
                cambios[0].textContent = cambioAmp;
                cambios[0].className = `metric-change ${eficienciaAmp > 10 ? 'positive' : 'negative'}`;
                
                cambios[1].textContent = cambioMej;
                cambios[1].className = `metric-change ${eficienciaMej > 5 ? 'positive' : 'negative'}`;
                
                cambios[4].textContent = cambioGeneral;
                cambios[4].className = `metric-change ${promedio > 8 ? 'positive' : 'negative'}`;
            }
        }
        
        // NUEVA FUNCI√ìN: Calcular eficiencia por macrodistrito
        function calcularEficienciaPorMacrodistrito() {
            const datosSolicitudes = obtenerDatosPorVariable('TOTAL DE SOLICITUDES RECIBIDAS');
            const datosDisenos = obtenerDatosPorVariable('DISE√ëOS TECNICOS APROBADOS');
            
            if (!datosSolicitudes || !datosDisenos) return {};
            
            const macrodistritos = ['cotahuma', 'max_paredes', 'periferica', 'san_antonio', 'zona_sur', 'mallasa', 'centro', 'hampaturi', 'zongo'];
            const eficiencias = {};
            
            macrodistritos.forEach(macro => {
                const solicitudesAmp = datosSolicitudes.ampliacion.macrodistritos[macro] || 0;
                const solicitudesMej = datosSolicitudes.mejoramiento.macrodistritos[macro] || 0;
                const disenosAmp = datosDisenos.ampliacion.macrodistritos[macro] || 0;
                const disenosMej = datosDisenos.mejoramiento.macrodistritos[macro] || 0;
                
                eficiencias[macro] = {
                    ampliacion: solicitudesAmp > 0 ? (disenosAmp / solicitudesAmp * 100) : 0,
                    mejoramiento: solicitudesMej > 0 ? (disenosMej / solicitudesMej * 100) : 0,
                    solicitudesAmp,
                    solicitudesMej,
                    disenosAmp,
                    disenosMej
                };
            });
            
            return eficiencias;
        }
        
        // NUEVA FUNCI√ìN: Validar consistencia de datos
        function validarConsistenciaDatos() {
            const datosSolicitudes = obtenerDatosPorVariable('TOTAL DE SOLICITUDES RECIBIDAS');
            const datosDisenos = obtenerDatosPorVariable('DISE√ëOS TECNICOS APROBADOS');
            
            if (!datosSolicitudes || !datosDisenos) return false;
            
            let errores = [];
            
            // Validar que los dise√±os aprobados no excedan las solicitudes
            if (datosDisenos.ampliacion.total > datosSolicitudes.ampliacion.total) {
                errores.push('Los dise√±os aprobados de Ampliaci√≥n no pueden exceder el total de solicitudes');
            }
            
            if (datosDisenos.mejoramiento.total > datosSolicitudes.mejoramiento.total) {
                errores.push('Los dise√±os aprobados de Mejoramiento no pueden exceder el total de solicitudes');
            }
            
            // Mostrar errores si los hay
            if (errores.length > 0) {
                errores.forEach(error => mostrarAlerta(error, 'danger'));
                return false;
            }
            
            return true;
        }
        
        // Inicializar al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            // Agregar bot√≥n para cargar datos de ejemplo
            const filterActions = document.querySelector('.filter-actions');
            const btnEjemplo = document.createElement('button');
            btnEjemplo.className = 'btn btn-info';
            btnEjemplo.innerHTML = 'üéØ Cargar Datos de Ejemplo';
            btnEjemplo.onclick = cargarDatosEjemplo;
            filterActions.appendChild(btnEjemplo);
        });
    </script>
</body>
</html>
