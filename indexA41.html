<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Registro de Lectura de Medidores – Ultra HD</title>

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        h1  { color: #222; }
        label { font-weight: bold; }
        input { margin: 5px 0; }
        button { margin: 10px 5px; padding: 5px 10px; font-size: 14px; }
        #registros { margin-top: 20px; }
        .registro {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 12px;
            border: 2px solid #aaa;
            border-radius: 5px;
            padding: 8px;
            background: #fafafa;
        }
        .columna { flex: 1; display: flex; flex-direction: column; }
        .columna img, .columna .mapa {
            width: 100%;
            height: 260px;
            object-fit: contain;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .info { flex: 1.2; font-size: 14px; }
        .info p { margin: 4px 0; }
        .borrar-btn {
            background-color: red;
            color: white;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 3px;
            align-self: center;
        }
        .titulo-col {
            font-weight: bold;
            text-align: center;
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <h1>Registro de Lectura de Medidores – Ultra HD</h1>

    <label for="medidor">N° Medidor:</label>
    <input type="text" id="medidor"><br>

    <label for="lectura">Lectura (kWh):</label>
    <input type="text" id="lectura"><br>

    <label for="foto">Foto del Medidor (máxima calidad):</label>
    <input type="file" id="foto" accept="image/*"><br><br>

    <button onclick="guardarRegistro()">Guardar Registro</button>
    <button onclick="borrarTodos()">Borrar Todos</button>

    <h2>Registros Guardados</h2>
    <div id="registros"></div>

    <script>
    /* --------------------------------------------------
       CONFIGURACIÓN MÁXIMA: imagen sin pérdida / JPEG 100
    -------------------------------------------------- */
    let registros = JSON.parse(localStorage.getItem("registros")) || [];
    let contador  = registros.length ? Math.max(...registros.map(r => r.id)) + 1 : 1;

    const MAX_CHUNK_SIZE = 1024 * 1024 * 4.5;   // 4.5 MB

    async function guardarRegistro() {
        const nro      = document.getElementById("medidor").value.trim();
        const lectura  = document.getElementById("lectura").value.trim();
        const fotoFile = document.getElementById("foto").files[0];

        if (!nro || !lectura || !fotoFile) {
            alert("Completa todos los campos");
            return;
        }

        try {
            const buffer = await fotoFile.arrayBuffer();
            const blob   = new Blob([buffer], { type: fotoFile.type });
            const img    = await createImageBitmap(blob);

            // Canvas al tamaño real
            const canvas = new OffscreenCanvas(img.width, img.height);
            const ctx    = canvas.getContext("2d");
            ctx.imageSmoothingEnabled = false; // imagen nítida
            ctx.drawImage(img, 0, 0);

            // PNG sin pérdida (true) o JPEG 100 % (false)
            const useLossless = true;
            const mime        = useLossless ? "image/png" : "image/jpeg";
            const quality     = useLossless ? undefined : 1.0;

            const blobOut = await canvas.convertToBlob({ type: mime, quality });

            if (blobOut.size > MAX_CHUNK_SIZE) {
                alert("La imagen es demasiado grande para almacenarla localmente.");
                return;
            }

            const reader = new FileReader();
            reader.onload = () => {
                const dataURL = reader.result;

                navigator.geolocation.getCurrentPosition(pos => {
                    const registro = {
                        nro,
                        lectura,
                        fecha: new Date().toLocaleString(),
                        lat: pos.coords.latitude,
                        lon: pos.coords.longitude,
                        foto: dataURL,
                        id: contador++
                    };

                    registros.push(registro);
                    localStorage.setItem("registros", JSON.stringify(registros));
                    mostrarRegistros();

                    // Reset
                    document.getElementById("medidor").value = "";
                    document.getElementById("lectura").value = "";
                    document.getElementById("foto").value   = "";
                }, err => alert("GPS: " + err.message));
            };
            reader.readAsDataURL(blobOut);

        } catch (e) {
            console.error(e);
            alert("Error procesando imagen: " + e.message);
        }
    }

    function mostrarRegistros() {
        const registrosDiv = document.getElementById("registros");
        registrosDiv.innerHTML = "";

        registros.forEach((reg, index) => {
            const registro = document.createElement("div");
            registro.className = "registro";
            registro.innerHTML = `
                <div class="info columna">
                    <p><b>N° Medidor:</b> ${reg.nro}</p>
                    <p><b>Lectura:</b> ${reg.lectura} kWh</p>
                    <p><b>Fecha:</b> ${reg.fecha}</p>
                    <p><b>Ubicación:</b> ${reg.lat.toFixed(5)}, ${reg.lon.toFixed(5)}</p>
                    <a href="https://www.google.com/maps?q=${reg.lat},${reg.lon}" target="_blank">Ver en Mapa</a>
                </div>
                <div class="columna">
                    <div class="titulo-col">Foto</div>
                    <img src="${reg.foto}">
                </div>
                <div class="columna">
                    <div class="titulo-col">Mapa</div>
                    <div class="mapa" id="map${reg.id}"></div>
                </div>
                <div class="columna" style="flex:0.3; justify-content:center;">
                    <button class="borrar-btn" onclick="borrarRegistro(${index})">Borrar</button>
                </div>
            `;
            registrosDiv.appendChild(registro);

            const map = L.map(`map${reg.id}`).setView([reg.lat, reg.lon], 16);
            L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19 })
             .addTo(map);
            L.marker([reg.lat, reg.lon]).addTo(map)
              .bindPopup("Ubicación del medidor")
              .openPopup();
        });
    }

    function borrarRegistro(index) {
        registros.splice(index, 1);
        localStorage.setItem("registros", JSON.stringify(registros));
        mostrarRegistros();
    }

    function borrarTodos() {
        if (!confirm("¿Seguro que quieres borrar todos los registros?")) return;
        registros = [];
        localStorage.removeItem("registros");
        document.getElementById("registros").innerHTML = "";
        document.getElementById("medidor").value = "";
        document.getElementById("lectura").value = "";
        document.getElementById("foto").value = "";
        contador = 1;
    }

    // Inicializar
    mostrarRegistros();
    </script>
</body>
</html>