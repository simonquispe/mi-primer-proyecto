<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Registro de Lectura de Medidores – Zoom Interactivo Pro</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        h1 { color: #222; }
        label { font-weight: bold; }
        input { margin: 5px 0; }
        button { margin: 10px 5px; padding: 5px 10px; font-size: 14px; }
        #registros { margin-top: 20px; }
        .registro {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 12px;
            border: 2px solid #28a745; /* Borde verde para la versión final */
            border-radius: 5px;
            padding: 8px;
            background: #fafafa;
        }
        .columna { flex: 1; display: flex; flex-direction: column; position: relative; }
        .columna .mapa {
            width: 100%;
            height: 260px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .info { flex: 1.2; font-size: 14px; }
        .info p { margin: 4px 0; }
        .borrar-btn { background-color: red; color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 3px; align-self: center; }
        .titulo-col { font-weight: bold; text-align: center; margin-bottom: 5px; }

        /* --- ESTILOS PARA ZOOM INTERACTIVO --- */
        .foto-container {
            position: relative;
            width: 100%;
            height: 260px;
            border: 1px solid #ccc;
            border-radius: 4px;
            overflow: hidden; /* Esencial para que la imagen no se salga */
            background-color: #eee;
        }
        .foto-container img {
            width: 100%;
            height: 100%;
            object-fit: contain; /* Empieza contenida */
            position: absolute;
            top: 0;
            left: 0;
            cursor: grab;
            transition: transform 0.2s ease-out;
        }
        .zoom-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 10;
            display: flex;
            flex-direction: column;
        }
        .zoom-btn {
            width: 30px;
            height: 30px;
            font-size: 20px;
            font-weight: bold;
            background-color: rgba(255, 255, 255, 0.8 );
            border: 1px solid #ccc;
            cursor: pointer;
            margin-bottom: 2px;
        }
        .zoom-btn:hover { background-color: #fff; }
        /* --- FIN ESTILOS ZOOM --- */

        @media (max-width: 768px) {
            .registro { flex-direction: column; align-items: stretch; }
            .columna { height: auto; }
            .foto-container, .columna .mapa { height: 250px; }
            .columna.columna-borrar { align-self: center; margin-top: 10px; }
        }
    </style>
</head>
<body>
    <h1>Registro de Lectura de Medidores – Zoom Interactivo Pro</h1>
    <label for="medidor">N° Medidor:</label>
    <input type="text" id="medidor">  

    <label for="lectura">Lectura (kWh):</label>
    <input type="text" id="lectura">  

    <label for="foto">Foto del Medidor (Máxima Calidad):</label>
    <input type="file" id="foto" accept="image/*">  
  

    <button onclick="guardarRegistro()">Guardar en la Nube</button>
    <button onclick="borrarTodos()">Borrar Todos</button>
    <h2>Registros Guardados</h2>
    <div id="registros"></div>

    <script>
    const CLOUD_NAME = "dhjsqpvxf";
    const UPLOAD_PRESET = "iubbveg6";
    let registros = JSON.parse(localStorage.getItem("registrosCloud")) || [];
    let contador = registros.length ? Math.max(...registros.map(r => r.id)) + 1 : 1;

    async function subirImagenACloudinary(file) { /* ... sin cambios ... */ }
    async function guardarRegistro() { /* ... sin cambios ... */ }
    function borrarRegistro(index) { /* ... sin cambios ... */ }
    function borrarTodos() { /* ... sin cambios ... */ }

    function mostrarRegistros() {
        const registrosDiv = document.getElementById("registros");
        registrosDiv.innerHTML = "";
        registros.forEach((reg, index) => {
            const registro = document.createElement("div");
            registro.className = "registro";
            registro.innerHTML = `
                <div class="info columna">
                    <p><b>N° Medidor:</b> ${reg.nro}</p>
                    <p><b>Lectura:</b> ${reg.lectura} kWh</p>
                    <p><b>Fecha:</b> ${reg.fecha}</p>
                    <p><b>Ubicación:</b> ${reg.lat.toFixed(5)}, ${reg.lon.toFixed(5)}</p>
                    <a href="https://www.google.com/maps?q=${reg.lat},${reg.lon}" target="_blank">Ver en Mapa</a>
                </div>
                <div class="columna">
                    <div class="titulo-col">Foto (desde la Nube )</div>
                    <!-- CONTENEDOR DE FOTO MEJORADO -->
                    <div class="foto-container" id="container-${reg.id}">
                        <img id="img-${reg.id}" src="${reg.foto}">
                        <div class="zoom-controls">
                            <button class="zoom-btn" onclick="zoomImagen('img-${reg.id}', 1.2)">+</button>
                            <button class="zoom-btn" onclick="zoomImagen('img-${reg.id}', 0.8)">-</button>
                        </div>
                    </div>
                </div>
                <div class="columna">
                    <div class="titulo-col">Mapa</div>
                    <div class="mapa" id="map${reg.id}"></div>
                </div>
                <div class="columna columna-borrar" style="flex:0.3; justify-content:center;">
                    <button class="borrar-btn" onclick="borrarRegistro(${index})">Borrar</button>
                </div>
            `;
            registrosDiv.appendChild(registro);
            const map = L.map(`map${reg.id}`).setView([reg.lat, reg.lon], 16);
            L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19 } ).addTo(map);
            L.marker([reg.lat, reg.lon]).addTo(map).bindPopup("Ubicación del medidor").openPopup();
            
            // Activar la funcionalidad de arrastre para la nueva imagen
            activarArrastre(`container-${reg.id}`);
        });
    }

    // --- NUEVAS FUNCIONES PARA ZOOM Y ARRASTRE ---
    let escalas = {}; // Objeto para guardar la escala de cada imagen

    function zoomImagen(imgId, factor) {
        const img = document.getElementById(imgId);
        if (!escalas[imgId]) escalas[imgId] = 1; // Inicia en 1 si no existe
        
        escalas[imgId] *= factor;
        // Limita el zoom para que no se haga demasiado grande o pequeño
        if (escalas[imgId] < 1) escalas[imgId] = 1;
        if (escalas[imgId] > 10) escalas[imgId] = 10;

        img.style.transform = `scale(${escalas[imgId]})`;
        // Si la escala vuelve a 1, la imagen se centra sola
        if (escalas[imgId] === 1) {
            img.style.left = '0px';
            img.style.top = '0px';
        }
    }

    function activarArrastre(containerId) {
        const container = document.getElementById(containerId);
        const img = container.querySelector('img');
        let isDown = false;
        let startX, startY, scrollLeft, scrollTop;

        container.addEventListener('mousedown', (e) => {
            if (escalas[img.id] <= 1) return; // Solo permite arrastrar si hay zoom
            isDown = true;
            img.style.cursor = 'grabbing';
            startX = e.pageX - container.offsetLeft;
            startY = e.pageY - container.offsetTop;
            scrollLeft = img.offsetLeft;
            scrollTop = img.offsetTop;
        });

        container.addEventListener('mouseleave', () => {
            isDown = false;
            img.style.cursor = 'grab';
        });

        container.addEventListener('mouseup', () => {
            isDown = false;
            img.style.cursor = 'grab';
        });

        container.addEventListener('mousemove', (e) => {
            if (!isDown) return;
            e.preventDefault();
            const x = e.pageX - container.offsetLeft;
            const y = e.pageY - container.offsetTop;
            const walkX = (x - startX);
            const walkY = (y - startY);
            img.style.left = (scrollLeft + walkX) + 'px';
            img.style.top = (scrollTop + walkY) + 'px';
        });
    }
    // --- FIN DE FUNCIONES NUEVAS ---

    // Copiamos las funciones que no cambiaron para mantener el código completo
    async function subirImagenACloudinary(file) { const url = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`; const formData = new FormData( ); formData.append('file', file); formData.append('upload_preset', UPLOAD_PRESET); const response = await fetch(url, { method: 'POST', body: formData }); if (!response.ok) throw new Error('No se pudo subir la imagen a Cloudinary.'); const data = await response.json(); return data.secure_url; }
    async function guardarRegistro() { const nro = document.getElementById("medidor").value.trim(); const lectura = document.getElementById("lectura").value.trim(); const fotoFile = document.getElementById("foto").files[0]; if (!nro || !lectura || !fotoFile) { alert("Completa todos los campos"); return; } const botonGuardar = document.querySelector('button[onclick="guardarRegistro()"]'); const textoOriginal = botonGuardar.textContent; botonGuardar.textContent = "Subiendo a la Nube..."; botonGuardar.disabled = true; try { const fotoURL = await subirImagenACloudinary(fotoFile); navigator.geolocation.getCurrentPosition(pos => { const registro = { nro, lectura, foto: fotoURL, fecha: new Date().toLocaleString(), lat: pos.coords.latitude, lon: pos.coords.longitude, id: contador++ }; registros.push(registro); localStorage.setItem("registrosCloud", JSON.stringify(registros)); mostrarRegistros(); document.getElementById("medidor").value = ""; document.getElementById("lectura").value = ""; document.getElementById("foto").value = ""; botonGuardar.textContent = textoOriginal; botonGuardar.disabled = false; }, err => { alert("Error de GPS: " + err.message); botonGuardar.textContent = textoOriginal; botonGuardar.disabled = false; }); } catch (error) { alert("Error al subir la imagen: " + error.message); botonGuardar.textContent = textoOriginal; botonGuardar.disabled = false; } }
    function borrarRegistro(index) { registros.splice(index, 1); localStorage.setItem("registrosCloud", JSON.stringify(registros)); mostrarRegistros(); }
    function borrarTodos() { if (!confirm("¿Seguro que quieres borrar todos los registros?")) return; registros = []; localStorage.removeItem("registrosCloud"); document.getElementById("registros").innerHTML = ""; document.getElementById("medidor").value = ""; document.getElementById("lectura").value = ""; document.getElementById("foto").value = ""; contador = 1; }

    // Inicializar
    mostrarRegistros();
    </script>
</body>
</html>
