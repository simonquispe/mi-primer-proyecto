<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Registro de Lectura de Medidores</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        h1 { color: #222; }
        label { font-weight: bold; }
        input { margin: 5px 0; }
        button {
            margin: 10px 0;
            padding: 5px 10px;
            font-size: 14px;
        }
        #registros { margin-top: 20px; }
        .registro {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 12px;
            border: 2px solid #aaa;
            border-radius: 5px;
            padding: 8px;
            background: #fafafa;
        }
        .columna { flex: 1; display: flex; flex-direction: column; }
        .columna img, .columna .mapa {
            width: 100%;
            height: 260px;
            object-fit: contain;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .info { flex: 1.2; font-size: 14px; }
        .info p { margin: 4px 0; }
        .borrar-btn {
            background-color: red;
            color: white;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 3px;
            align-self: center;
        }
        .titulo-col {
            font-weight: bold;
            text-align: center;
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <h1>Registro de Lectura de Medidores</h1>

    <label for="nro">NÂ° Medidor:</label>
    <input type="text" id="nro"><br>
    <label for="lectura">Lectura (kWh):</label>
    <input type="text" id="lectura"><br>
    <label for="foto">Foto del Medidor (cÃ¡mara o archivo):</label>
    <input type="file" id="foto" accept="image/*"><br><br>
    <button onclick="guardarRegistro()">Guardar Registro</button>
    <button onclick="borrarTodos()">Borrar Todos</button>

    <h2>Registros Guardados</h2>
    <div id="registros"></div>

    <script>
        let contador = 1;

        function guardarRegistro() {
            const nro = document.getElementById("nro").value;
            const lectura = document.getElementById("lectura").value;
            const fotoInput = document.getElementById("foto");
            const archivoFoto = fotoInput.files[0];

            if (!nro || !lectura || !archivoFoto) {
                alert("Por favor completa todos los campos");
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                navigator.geolocation.getCurrentPosition(function(pos) {
                    const lat = pos.coords.latitude;
                    const lon = pos.coords.longitude;

                    const registro = document.createElement("div");
                    registro.className = "registro";

                    registro.innerHTML = `
                        <div class="info columna">
                            <p><b>NÂ° Medidor:</b> ${nro}</p>
                            <p><b>Lectura:</b> ${lectura} kWh</p>
                            <p><b>Fecha:</b> ${new Date().toLocaleString()}</p>
                            <p><b>UbicaciÃ³n:</b> ${lat.toFixed(5)}, ${lon.toFixed(5)}</p>
                            <a href="https://www.google.com/maps?q=${lat},${lon}" target="_blank">Ver en Mapa</a>
                        </div>
                        <div class="columna">
                            <div class="titulo-col">Foto</div>
                            <img src="${e.target.result}">
                        </div>
                        <div class="columna">
                            <div class="titulo-col">Mapa</div>
                            <div class="mapa" id="map${contador}"></div>
                        </div>
                        <div class="columna" style="flex:0.3; justify-content:center;">
                            <button class="borrar-btn" onclick="this.closest('.registro').remove()">Borrar</button>
                        </div>
                    `;

                    document.getElementById("registros").appendChild(registro);

                    // Inicializar mapa con marcador
                    const map = L.map(`map${contador}`).setView([lat, lon], 16);
                    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                        maxZoom: 19,
                    }).addTo(map);
                    L.marker([lat, lon]).addTo(map).bindPopup("UbicaciÃ³n del medidor").openPopup();

                    contador++;
                });
            };
            reader.readAsDataURL(archivoFoto);
        }

        function borrarTodos() {
            const registrosDiv = document.getElementById("registros");
            registrosDiv.innerHTML = ""; // ðŸ”¥ elimina todos los registros
            contador = 1; // reinicia contador de mapas
        }
    </script>
</body>
</html>
