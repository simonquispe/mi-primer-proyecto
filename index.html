<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Registro de Lectura de Medidores – Lightbox Pro</title>

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        h1  { color: #222; }
        label { font-weight: bold; }
        input { margin: 5px 0; }
        button { margin: 10px 5px; padding: 5px 10px; font-size: 14px; }
        #registros { margin-top: 20px; }
        .registro {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 12px;
            border: 2px solid #007BFF;
            border-radius: 5px;
            padding: 8px;
            background: #fafafa;
        }
        .columna { flex: 1; display: flex; flex-direction: column; }
        .columna img, .columna .mapa {
            width: 100%;
            height: 260px;
            object-fit: contain;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .info { flex: 1.2; font-size: 14px; }
        .info p { margin: 4px 0; }
        .borrar-btn {
            background-color: red;
            color: white;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 3px;
            align-self: center;
        }
        .titulo-col {
            font-weight: bold;
            text-align: center;
            margin-bottom: 5px;
        }

        /* --- INICIO DEL CÓDIGO ADAPTATIVO --- */
        @media (max-width: 768px ) {
            .registro {
                flex-direction: column;
                align-items: stretch;
            }
            .columna { height: auto; }
            .columna img, .columna .mapa {
                height: 250px;
                object-fit: cover;
            }
            .columna.columna-borrar {
                align-self: center;
                margin-top: 10px;
            }
        }
        /* --- FIN DEL CÓDIGO ADAPTATIVO --- */

        /* --- INICIO DE ESTILOS PARA LIGHTBOX --- */
        .lightbox {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            justify-content: center;
            align-items: center;
        }
        .lightbox-content {
            max-width: 90%;
            max-height: 90%;
            animation: zoom 0.3s ease-in-out;
        }
        @keyframes zoom {
            from {transform: scale(0.5);}
            to {transform: scale(1);}
        }
        .lightbox-close {
            position: absolute;
            top: 20px;
            right: 35px;
            color: #fff;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
        }
        .lightbox-close:hover { color: #bbb; }
        .columna img { cursor: pointer; }
        /* --- FIN DE ESTILOS PARA LIGHTBOX --- */
    </style>
</head>
<body>
    <!-- Contenedor del Lightbox (inicialmente oculto) -->
    <div id="myLightbox" class="lightbox">
        <span class="lightbox-close">&times;</span>
        <img class="lightbox-content" id="lightboxImg">
    </div>

    <h1>Registro de Lectura de Medidores – Lightbox Pro</h1>

    <label for="medidor">N° Medidor:</label>
    <input type="text" id="medidor">  


    <label for="lectura">Lectura (kWh):</label>
    <input type="text" id="lectura">  


    <label for="foto">Foto del Medidor (Máxima Calidad):</label>
    <input type="file" id="foto" accept="image/*">  
  


    <button onclick="guardarRegistro()">Guardar en la Nube</button>
    <button onclick="borrarTodos()">Borrar Todos</button>

    <h2>Registros Guardados</h2>
    <div id="registros"></div>

    <script>
    // --- CONFIGURACIÓN DE CLOUDINARY ---
    const CLOUD_NAME = "dhjsqpvxf";
    const UPLOAD_PRESET = "iubbveg6";
    // ------------------------------------

    let registros = JSON.parse(localStorage.getItem("registrosCloud")) || [];
    let contador  = registros.length ? Math.max(...registros.map(r => r.id)) + 1 : 1;

    async function subirImagenACloudinary(file) {
        const url = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`;
        const formData = new FormData( );
        formData.append('file', file);
        formData.append('upload_preset', UPLOAD_PRESET);

        const response = await fetch(url, { method: 'POST', body: formData });
        if (!response.ok) throw new Error('No se pudo subir la imagen a Cloudinary.');
        const data = await response.json();
        return data.secure_url;
    }

    async function guardarRegistro() {
        const nro      = document.getElementById("medidor").value.trim();
        const lectura  = document.getElementById("lectura").value.trim();
        const fotoFile = document.getElementById("foto").files[0];

        if (!nro || !lectura || !fotoFile) {
            alert("Completa todos los campos");
            return;
        }

        const botonGuardar = document.querySelector('button[onclick="guardarRegistro()"]');
        const textoOriginal = botonGuardar.textContent;
        botonGuardar.textContent = "Subiendo a la Nube...";
        botonGuardar.disabled = true;

        try {
            const fotoURL = await subirImagenACloudinary(fotoFile);
            navigator.geolocation.getCurrentPosition(pos => {
                const registro = {
                    nro, lectura, foto: fotoURL,
                    fecha: new Date().toLocaleString(),
                    lat: pos.coords.latitude,
                    lon: pos.coords.longitude,
                    id: contador++
                };
                registros.push(registro);
                localStorage.setItem("registrosCloud", JSON.stringify(registros));
                mostrarRegistros();
                document.getElementById("medidor").value = "";
                document.getElementById("lectura").value = "";
                document.getElementById("foto").value   = "";
                botonGuardar.textContent = textoOriginal;
                botonGuardar.disabled = false;
            }, err => {
                alert("Error de GPS: " + err.message);
                botonGuardar.textContent = textoOriginal;
                botonGuardar.disabled = false;
            });
        } catch (error) {
            alert("Error al subir la imagen: " + error.message);
            botonGuardar.textContent = textoOriginal;
            botonGuardar.disabled = false;
        }
    }

    function mostrarRegistros() {
        const registrosDiv = document.getElementById("registros");
        registrosDiv.innerHTML = "";
        registros.forEach((reg, index) => {
            const registro = document.createElement("div");
            registro.className = "registro";
            registro.innerHTML = `
                <div class="info columna">
                    <p><b>N° Medidor:</b> ${reg.nro}</p>
                    <p><b>Lectura:</b> ${reg.lectura} kWh</p>
                    <p><b>Fecha:</b> ${reg.fecha}</p>
                    <p><b>Ubicación:</b> ${reg.lat.toFixed(5)}, ${reg.lon.toFixed(5)}</p>
                    <a href="https://www.google.com/maps?q=${reg.lat},${reg.lon}" target="_blank">Ver en Mapa</a>
                </div>
                <div class="columna">
                    <div class="titulo-col">Foto (desde la Nube )</div>
                    <img src="${reg.foto}" onclick="abrirLightbox('${reg.foto}')">
                </div>
                <div class="columna">
                    <div class="titulo-col">Mapa</div>
                    <div class="mapa" id="map${reg.id}"></div>
                </div>
                <div class="columna columna-borrar" style="flex:0.3; justify-content:center;">
                    <button class="borrar-btn" onclick="borrarRegistro(${index})">Borrar</button>
                </div>
            `;
            registrosDiv.appendChild(registro);
            const map = L.map(`map${reg.id}`).setView([reg.lat, reg.lon], 16);
            L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19 } ).addTo(map);
            L.marker([reg.lat, reg.lon]).addTo(map).bindPopup("Ubicación del medidor").openPopup();
        });
    }

    function borrarRegistro(index) {
        registros.splice(index, 1);
        localStorage.setItem("registrosCloud", JSON.stringify(registros));
        mostrarRegistros();
    }

    function borrarTodos() {
        if (!confirm("¿Seguro que quieres borrar todos los registros?")) return;
        registros = [];
        localStorage.removeItem("registrosCloud");
        document.getElementById("registros").innerHTML = "";
        document.getElementById("medidor").value = "";
        document.getElementById("lectura").value = "";
        document.getElementById("foto").value = "";
        contador = 1;
    }

    // --- INICIO DE FUNCIONES PARA LIGHTBOX ---
    function abrirLightbox(urlImagen) {
        const lightbox = document.getElementById('myLightbox');
        const lightboxImg = document.getElementById('lightboxImg');
        lightboxImg.src = urlImagen;
        lightbox.style.display = "flex";
        const cerrar = () => lightbox.style.display = "none";
        document.querySelector('.lightbox-close').onclick = cerrar;
        lightbox.onclick = (event) => { if (event.target === lightbox) cerrar(); };
    }
    // --- FIN DE FUNCIONES PARA LIGHTBOX ---

    // Inicializar
    mostrarRegistros();
    </script>
</body>
</html>
