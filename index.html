<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Registro de Lectura de Medidores – ULTRA HD Cloud Edition</title>

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        h1  { color: #222; }
        label { font-weight: bold; }
        input { margin: 5px 0; }
        button { margin: 10px 5px; padding: 5px 10px; font-size: 14px; }
        #registros { margin-top: 20px; }
        .registro {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 12px;
            border: 2px solid #007BFF; /* Borde azul para destacar la versión Cloud */
            border-radius: 5px;
            padding: 8px;
            background: #fafafa;
        }
        .columna { flex: 1; display: flex; flex-direction: column; }
        .columna img, .columna .mapa {
            width: 100%;
            height: 260px;
            object-fit: contain;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .info { flex: 1.2; font-size: 14px; }
        .info p { margin: 4px 0; }
        .borrar-btn {
            background-color: red;
            color: white;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 3px;
            align-self: center;
        }
        .titulo-col {
            font-weight: bold;
            text-align: center;
            margin-bottom: 5px;
        }

/* --- INICIO DEL NUEVO CÓDIGO ADAPTATIVO --- */

/* Media Query para pantallas pequeñas (móviles en vertical) */
@media (max-width: 768px) {
    .registro {
        flex-direction: column; /* Apila las columnas verticalmente */
        align-items: stretch;   /* Estira las columnas para que ocupen todo el ancho */
    }

    .columna {
        height: auto; /* Altura automática para el contenido */
    }

    .columna img, .columna .mapa {
        height: 250px; /* Mantenemos una altura fija para la imagen y el mapa */
        object-fit: cover; /* La imagen cubrirá el espacio para verse mejor */
    }

    .columna.columna-borrar {
        align-self: center; /* Centra el botón de borrar */
        margin-top: 10px;
    }
}

/* --- FIN DEL NUEVO CÓDIGO ADAPTATIVO --- */
        
    </style>
</head>
<body>
    <h1>Registro de Lectura de Medidores – ULTRA HD Cloud Edition</h1>

    <label for="medidor">N° Medidor:</label>
    <input type="text" id="medidor">  


    <label for="lectura">Lectura (kWh ):</label>
    <input type="text" id="lectura">  


    <label for="foto">Foto del Medidor (Máxima Calidad):</label>
    <input type="file" id="foto" accept="image/*">  
  


    <button onclick="guardarRegistro()">Guardar en la Nube</button>
    <button onclick="borrarTodos()">Borrar Todos</button>

    <h2>Registros Guardados</h2>
    <div id="registros"></div>

    <script>
    /* --------------------------------------------------
       VERSIÓN CON CONEXIÓN A CLOUDINARY
    -------------------------------------------------- */

    // --- CONFIGURACIÓN DE CLOUDINARY ---
    // ¡¡¡REEMPLAZA ESTOS VALORES CON LOS TUYOS!!!
    const CLOUD_NAME = "dhjsqpvxf";
    const UPLOAD_PRESET = "iubbveg6";
    // ------------------------------------

    let registros = JSON.parse(localStorage.getItem("registrosCloud")) || [];
    let contador  = registros.length ? Math.max(...registros.map(r => r.id)) + 1 : 1;

    async function subirImagenACloudinary(file) {
        const url = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`;
        const formData = new FormData( );
        formData.append('file', file);
        formData.append('upload_preset', UPLOAD_PRESET);

        const response = await fetch(url, {
            method: 'POST',
            body: formData
        });

        if (!response.ok) {
            throw new Error('No se pudo subir la imagen a Cloudinary.');
        }

        const data = await response.json();
        return data.secure_url; // Devuelve la URL segura de la imagen en la nube
    }

    async function guardarRegistro() {
        const nro      = document.getElementById("medidor").value.trim();
        const lectura  = document.getElementById("lectura").value.trim();
        const fotoFile = document.getElementById("foto").files[0];

        if (!nro || !lectura || !fotoFile) {
            alert("Completa todos los campos");
            return;
        }

        const botonGuardar = document.querySelector('button[onclick="guardarRegistro()"]');
        const textoOriginal = botonGuardar.textContent;
        botonGuardar.textContent = "Subiendo a la Nube...";
        botonGuardar.disabled = true;

        try {
            // 1. Subir la imagen a Cloudinary y obtener la URL
            const fotoURL = await subirImagenACloudinary(fotoFile);

            // 2. Obtener la ubicación GPS
            navigator.geolocation.getCurrentPosition(pos => {
                const registro = {
                    nro,
                    lectura,
                    fecha: new Date().toLocaleString(),
                    lat: pos.coords.latitude,
                    lon: pos.coords.longitude,
                    foto: fotoURL, // <-- ¡Guardamos solo la URL de la nube!
                    id: contador++
                };

                registros.push(registro);
                localStorage.setItem("registrosCloud", JSON.stringify(registros));
                mostrarRegistros();

                // Reset
                document.getElementById("medidor").value = "";
                document.getElementById("lectura").value = "";
                document.getElementById("foto").value   = "";
                
                botonGuardar.textContent = textoOriginal;
                botonGuardar.disabled = false;

            }, err => {
                alert("Error de GPS: " + err.message);
                botonGuardar.textContent = textoOriginal;
                botonGuardar.disabled = false;
            });

        } catch (error) {
            alert("Error al subir la imagen: " + error.message);
            botonGuardar.textContent = textoOriginal;
            botonGuardar.disabled = false;
        }
    }

    function mostrarRegistros() {
        const registrosDiv = document.getElementById("registros");
        registrosDiv.innerHTML = "";

        registros.forEach((reg, index) => {
            const registro = document.createElement("div");
            registro.className = "registro";
            registro.innerHTML = `
                <div class="info columna">
                
                    <p><b>N° Medidor:</b> ${reg.nro}</p>
                    <p><b>Lectura:</b> ${reg.lectura} kWh</p>
                    <p><b>Fecha:</b> ${reg.fecha}</p>
                    <p><b>Ubicación:</b> ${reg.lat.toFixed(5)}, ${reg.lon.toFixed(5)}</p>
                    <a href="https://www.google.com/maps?q=${reg.lat},${reg.lon}" target="_blank">Ver en Mapa</a>
                </div>
                <div class="columna">
                    <div class="titulo-col">Foto (desde la Nube )</div>
                    <img src="${reg.foto}">
                </div>
                <div class="columna">
                    <div class="titulo-col">Mapa</div>
                    <div class="mapa" id="map${reg.id}"></div>
                </div>
                    <button class="borrar-btn" onclick="borrarRegistro(${index})">Borrar</button>
                    <div class="columna columna-borrar" style="flex:0.3; justify-content:center;">
                </div>
            `;
            registrosDiv.appendChild(registro);

            const map = L.map(`map${reg.id}`).setView([reg.lat, reg.lon], 16);
            L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19 } )
             .addTo(map);
            L.marker([reg.lat, reg.lon]).addTo(map)
              .bindPopup("Ubicación del medidor")
              .openPopup();
        });
    }

    function borrarRegistro(index) {
        registros.splice(index, 1);
        localStorage.setItem("registrosCloud", JSON.stringify(registros));
        mostrarRegistros();
    }

    function borrarTodos() {
        if (!confirm("¿Seguro que quieres borrar todos los registros?")) return;
        registros = [];
        localStorage.removeItem("registrosCloud");
        document.getElementById("registros").innerHTML = "";
        document.getElementById("medidor").value = "";
        document.getElementById("lectura").value = "";
        document.getElementById("foto").value = "";
        contador = 1;
    }

    // Inicializar
    mostrarRegistros();
    </script>
</body>
</html>
